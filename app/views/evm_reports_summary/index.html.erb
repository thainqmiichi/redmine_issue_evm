<% html_title l(:label_evm_reports_summary) %>

<div class="evm-reports-summary">
  <div class="contextual">
    <%= link_to l(:label_export_csv), evm_reports_summary_path(format: 'csv', week: @selected_week, status: @project_status), class: 'icon icon-download' %>
  </div>

    <h2><%= l(:label_evm_reports_summary) %></h2>

  <div class="evm-explanation">
    <p><strong>Explanation:</strong></p>
    <ul>
      <li><strong>Previous Report EVM:</strong> EVM metrics from the previous report</li>
      <li><strong>Current Report EVM:</strong> Current EVM metrics (latest report)</li>
      <li><strong>Changes Between Reports:</strong> Changes between two reports (current - previous)</li>
    </ul>
  </div>

  <div class="filters">
  <%= form_tag evm_reports_summary_path, method: :get, id: 'evm-reports-summary-form' do %>
    <fieldset class="box tabular">
      <legend><%= l(:label_filter_plural) %></legend>
      
      <p class="week-selector-container">
        <label for="week"><%= l(:label_week) %>:</label>
        <%= select_tag 'week', 
            options_for_select(@available_weeks.map { |w| [w[:label], w[:value]] }, @selected_week),
            onchange: 'this.form.submit();',
            class: 'week-dropdown',
            id: 'week-select' %>
      </p>
      
      <p>
        <label for="status"><%= l(:field_status) %>:</label>
        <%= select_tag 'status',
            options_for_select(@status_options, @project_status),
            onchange: 'this.form.submit();' %>
      </p>
      
      <p>
        <%= submit_tag l(:button_apply), class: 'button-positive' %>
        <%= link_to l(:button_clear), evm_reports_summary_path, class: 'button' %>
      </p>
    </fieldset>
  <% end %>
</div>

<% if @reports_data.any? %>
  <% @reports_data.each do |data| %>
    <div class="project-evm-section">
      <h3><%= link_to data[:project].name, project_path(data[:project]) %></h3>
      
      <div class="autoscroll">
        <table class="list evm-reports-table">
          <thead>
            <tr>
              <th title="Report Type - Report Type"></th>
              <th><%= l(:label_status_date) %></th>
              <th><%= l(:label_bac) %></th>
              <th><%= l(:label_pv) %></th>
              <th><%= l(:label_ev) %></th>
              <th><%= l(:label_ac) %></th>
              <th><%= l(:label_sv) %></th>
              <th><%= l(:label_cv) %></th>
              <th><%= l(:label_spi) %></th>
              <th><%= l(:label_cpi) %></th>
            </tr>
          </thead>
          <tbody>
            <!-- Previous Report EVM - Metrics from previous report -->
            <tr class="<%= cycle('odd', 'even') %>">
              <td class="report-type"><%= l(:label_report_evm_previous) %></td>
              <td><%= data[:all_previous_zero] ? '-' : format_date(data[:previous_status_date]) %></td>
              <td class="evm-value"><%= format_previous_evm_value(data[:previous_data][:bac], data[:all_previous_zero]) %></td>
              <td class="evm-value"><%= format_previous_evm_value(data[:previous_data][:pv], data[:all_previous_zero]) %></td>
              <td class="evm-value"><%= format_previous_evm_value(data[:previous_data][:ev], data[:all_previous_zero]) %></td>
              <td class="evm-value"><%= format_previous_evm_value(data[:previous_data][:ac], data[:all_previous_zero]) %></td>
              <td class="evm-value">
                <%= format_previous_evm_value(data[:previous_data][:sv], data[:all_previous_zero]) %>
              </td>
              <td class="evm-value">
                <%= format_previous_evm_value(data[:previous_data][:cv], data[:all_previous_zero]) %>
              </td>
              <td class="evm-value <%= evm_bg_class(data[:previous_data][:spi]) %>">
                <%= format_previous_evm_value(data[:previous_data][:spi], data[:all_previous_zero]) %>
              </td>
              <td class="evm-value <%= evm_bg_class(data[:previous_data][:cpi]) %>">
                <%= format_previous_evm_value(data[:previous_data][:cpi], data[:all_previous_zero]) %>
              </td>
            </tr>
            
            <!-- Current Report EVM - Current metrics -->
            <tr class="<%= cycle('odd', 'even') %>">
              <td class="report-type"><%= l(:label_report_evm_report) %></td>
              <td><%= format_date(data[:status_date]) %></td>
              <td class="evm-value"><%= format_evm_value(data[:current_data][:bac]) %></td>
              <td class="evm-value"><%= format_evm_value(data[:current_data][:pv]) %></td>
              <td class="evm-value"><%= format_evm_value(data[:current_data][:ev]) %></td>
              <td class="evm-value"><%= format_evm_value(data[:current_data][:ac]) %></td>
              <td class="evm-value">
                <%= format_evm_value(data[:current_data][:sv]) %>
              </td>
              <td class="evm-value">
                <%= format_evm_value(data[:current_data][:cv]) %>
              </td>
              <td class="evm-value <%= evm_bg_class(data[:current_data][:spi]) %>">
                <%= format_evm_value(data[:current_data][:spi]) %>
              </td>
              <td class="evm-value <%= evm_bg_class(data[:current_data][:cpi]) %>">
                <%= format_evm_value(data[:current_data][:cpi]) %>
              </td>
            </tr>
            
            <!-- Changes Between Reports - Changes between two reports -->
            <tr class="<%= cycle('odd', 'even') %>">
              <td class="report-type"><%= l(:label_report_evm_difference) %></td>
              <td><%= format_evm_value(data[:differences][:status_date]) %></td>
              <td class="evm-value">
                <%= format_evm_value(data[:differences][:bac]) %>
              </td>
              <td class="evm-value">
                <%= format_evm_value(data[:differences][:pv]) %>
              </td>
              <td class="evm-value">
                <%= format_evm_value(data[:differences][:ev]) %>
              </td>
              <td class="evm-value">
                <%= format_evm_value(data[:differences][:ac]) %>
              </td>
              <td class="evm-value">
                <%= format_evm_value(data[:differences][:sv]) %>
              </td>
              <td class="evm-value">
                <%= format_evm_value(data[:differences][:cv]) %>
              </td>
              <td class="evm-value">
                <%= format_evm_value(data[:differences][:spi]) %>
              </td>
              <td class="evm-value">
                <%= format_evm_value(data[:differences][:cpi]) %>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <!-- Note section for current report -->
      <% if data[:note].present? %>
        <div class="report-note-section">
          <h4><%= l(:label_note) %>:</h4>
          <div class="note-content">
            <pre><%= h(data[:note]) %></pre>
          </div>
          <div class="note-actions">
            <%= link_to l(:label_view_full_report), project_evmreport_path(data[:project], data[:current_report].id), class: 'icon icon-report' %>
          </div>
        </div>
      <% end %>
    </div>
  <% end %>

  <div class="summary">
    <p>
      <%= l(:label_showing_reports, count: @reports_data.count) %> projects
      <%= l(:label_for_week, week: "#{format_date(@selected_week_start)} - #{format_date(@selected_week_end)}") %>
      <% if @project_status.present? %>
        | Status: <%= @status_options.find { |label, value| value == @project_status }&.first %>
      <% end %>
    </p>
  </div>
<% else %>
  <p class="nodata"><%= l(:label_no_data) %></p>
<% end %>
</div>

<% content_for :header_tags do %>
  <%= stylesheet_link_tag 'issue_evm', plugin: 'redmine_issue_evm' %>
<% end %>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Simple dropdown week selector - no external libraries
      console.log('Using simple dropdown week selector');
      
      // Auto-submit form when any select changes
      const form = document.getElementById('evm-reports-summary-form');
      const selects = form.querySelectorAll('select');
      
      selects.forEach(function(select) {
        select.addEventListener('change', function() {
          form.submit();
        });
      });
    });
</script>

<style>
  .bg-color-red {
    background-color: #ff0000;
  }
  .bg-color-orange {
    background-color: #ff8c00;
  }
</style>
